"use strict";var ie=Object.create;var h=Object.defineProperty;var ne=Object.getOwnPropertyDescriptor;var ae=Object.getOwnPropertyNames;var ce=Object.getPrototypeOf,me=Object.prototype.hasOwnProperty;var H=(e,t)=>()=>(e&&(t=e(e=0)),t);var K=(e,t)=>{for(var o in t)h(e,o,{get:t[o],enumerable:!0})},W=(e,t,o,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of ae(t))!me.call(e,r)&&r!==o&&h(e,r,{get:()=>t[r],enumerable:!(i=ne(t,r))||i.enumerable});return e};var ue=(e,t,o)=>(o=e!=null?ie(ce(e)):{},W(t||!e||!e.__esModule?h(o,"default",{value:e,enumerable:!0}):o,e)),q=e=>W(h({},"__esModule",{value:!0}),e);var O,T,n,De,C,u,p,_=H(()=>{"use strict";O={DEV:"dev",STAGING:"staging",PROD:"prod"},T=process.env.STAGE||O.DEV,n={TOPICS:process.env.TOPICS_TABLE||`MicroQueue-Topics-${T}`,MESSAGES:process.env.MESSAGES_TABLE||`MicroQueue-Messages-${T}`,CONSUMER_GROUPS:process.env.CONSUMER_GROUPS_TABLE||`MicroQueue-ConsumerGroups-${T}`,OFFSETS:process.env.OFFSETS_TABLE||`MicroQueue-Offsets-${T}`},De={MESSAGES:process.env.MESSAGES_BUCKET||`microqueue-messages-${T}`,ARCHIVE:process.env.ARCHIVE_BUCKET||`microqueue-archive-${T}`},C={MAX_TOPIC_NAME_LENGTH:100,MAX_DESCRIPTION_LENGTH:500,MAX_MESSAGE_SIZE_BYTES:256*1024,MAX_METADATA_KEYS:10,MAX_METADATA_KEY_LENGTH:128,MAX_METADATA_VALUE_LENGTH:256,MAX_RETENTION_HOURS:7*24,DEFAULT_RETENTION_HOURS:24,MAX_MESSAGES_PER_CONSUME:100,DEFAULT_MESSAGES_PER_CONSUME:10,MAX_WAIT_TIME_SECONDS:20,DEFAULT_WAIT_TIME_SECONDS:0},u={INTERNAL_ERROR:"INTERNAL_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",RESOURCE_NOT_FOUND:"RESOURCE_NOT_FOUND",TOPIC_NOT_FOUND:"TOPIC_NOT_FOUND",TOPIC_ALREADY_EXISTS:"TOPIC_ALREADY_EXISTS",MESSAGE_NOT_FOUND:"MESSAGE_NOT_FOUND",MESSAGE_TOO_LARGE:"MESSAGE_TOO_LARGE",INVALID_MESSAGE_FORMAT:"INVALID_MESSAGE_FORMAT",CONSUMER_GROUP_NOT_FOUND:"CONSUMER_GROUP_NOT_FOUND",CONSUMER_GROUP_ALREADY_EXISTS:"CONSUMER_GROUP_ALREADY_EXISTS",RATE_LIMIT_EXCEEDED:"RATE_LIMIT_EXCEEDED",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE"},p={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,CONFLICT:409,PAYLOAD_TOO_LARGE:413,UNPROCESSABLE_ENTITY:422,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,SERVICE_UNAVAILABLE:503}});var Q={};K(Q,{config:()=>M,default:()=>le});var pe,j,Ee,M,le,V=H(()=>{"use strict";_();pe={serviceName:"MicroQueue-Mini",version:"1.0.0",dynamodb:{maxRetries:3,timeout:5e3},s3:{maxRetries:3,timeout:1e4},api:{corsOrigins:"*",rateLimit:{windowMs:60*1e3,max:100}},logging:{level:"info",format:"json"},topics:{maxTopicsPerAccount:100,defaultRetentionHours:C.DEFAULT_RETENTION_HOURS},messages:{maxSizeBytes:C.MAX_MESSAGE_SIZE_BYTES,batchSize:25},consumers:{defaultMaxMessages:C.DEFAULT_MESSAGES_PER_CONSUME,defaultWaitTimeSeconds:C.DEFAULT_WAIT_TIME_SECONDS}},j={[O.DEV]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:20}},[O.STAGING]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:50}},[O.PROD]:{logging:{level:"info"},topics:{maxTopicsPerAccount:100},api:{rateLimit:{windowMs:60*1e3,max:200}}}},Ee=j[T]||j[O.DEV],M={...pe,...Ee,env:T},le=M});var Ue={};K(Ue,{handler:()=>be});module.exports=q(Ue);var J=require("aws-sdk");V();var k={maxRetries:M.dynamodb.maxRetries,httpOptions:{timeout:M.dynamodb.timeout}};process.env.DYNAMODB_ENDPOINT&&(k.endpoint=process.env.DYNAMODB_ENDPOINT);var a=new J.DynamoDB.DocumentClient(k);_();var I=(V(),q(Q));var Te={error:0,warn:1,info:2,debug:3},D=Te[I.logging.level]||2,L=(e,t,o)=>{let i=new Date().toISOString(),r=process.env.AWS_REQUEST_ID||"-";if(I.logging.format==="json"){let l={timestamp:i,level:e,message:t,requestId:r,service:I.serviceName,version:I.version,env:I.env,...o?{data:o}:{}};return JSON.stringify(l)}let s=`[${i}] [${e.toUpperCase()}] [${r}] ${t}`;return o&&(s+=` ${JSON.stringify(o)}`),s},B=class{error(t,o){D>=0&&console.error(L("error",t,o))}warn(t,o){D>=1&&console.warn(L("warn",t,o))}info(t,o){D>=2&&console.info(L("info",t,o))}debug(t,o){D>=3&&console.debug(L("debug",t,o))}},c=new B,E=c;_();var m=class extends Error{constructor(o,i,r,s){super(i);this.code=o,this.statusCode=r,this.details=s,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,m)}toResponse(){return{success:!1,error:{code:this.code,message:this.message,details:this.details}}}},g={internalError:(e="An internal server error occurred",t)=>new m(u.INTERNAL_ERROR,e,p.INTERNAL_SERVER_ERROR,t),validationError:(e="Validation error",t)=>new m(u.VALIDATION_ERROR,e,p.BAD_REQUEST,t),resourceNotFound:(e,t)=>new m(u.RESOURCE_NOT_FOUND,`${e} with id '${t}' not found`,p.NOT_FOUND),topicNotFound:e=>new m(u.TOPIC_NOT_FOUND,`Topic '${e}' not found`,p.NOT_FOUND),topicAlreadyExists:e=>new m(u.TOPIC_ALREADY_EXISTS,`Topic with name '${e}' already exists`,p.CONFLICT),messageNotFound:e=>new m(u.MESSAGE_NOT_FOUND,`Message '${e}' not found`,p.NOT_FOUND),messageTooLarge:(e,t)=>new m(u.MESSAGE_TOO_LARGE,`Message size (${e} bytes) exceeds maximum allowed size (${t} bytes)`,p.PAYLOAD_TOO_LARGE),consumerGroupNotFound:e=>new m(u.CONSUMER_GROUP_NOT_FOUND,`Consumer group '${e}' not found`,p.NOT_FOUND),consumerGroupAlreadyExists:(e,t)=>new m(u.CONSUMER_GROUP_ALREADY_EXISTS,`Consumer group with name '${e}' already exists for topic '${t}'`,p.CONFLICT),rateLimitExceeded:()=>new m(u.RATE_LIMIT_EXCEEDED,"Rate limit exceeded",p.TOO_MANY_REQUESTS),serviceUnavailable:(e="Service temporarily unavailable")=>new m(u.SERVICE_UNAVAILABLE,e,p.SERVICE_UNAVAILABLE)};var Z=ue(require("aws-sdk")),ge=new Z.default.CloudWatch,Se=async e=>{c.debug("Calculating topic metrics",{topicId:e});try{let t=await a.get({TableName:n.TOPICS,Key:{topicId:e}}).promise();if(!t.Item)throw g.topicNotFound(e);let o=t.Item,i=Date.now()-60*60*1e3,l=((await a.query({TableName:n.MESSAGES,KeyConditionExpression:"topicId = :topicId AND sequenceNumber > :seq",FilterExpression:"#ts >= :ts",ExpressionAttributeNames:{"#ts":"timestamp"},ExpressionAttributeValues:{":topicId":e,":seq":0,":ts":i},Select:"COUNT"}).promise()).Count||0)/60,x=((await a.query({TableName:n.MESSAGES,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e},Limit:100,ScanIndexForward:!1,ProjectionExpression:"size"}).promise()).Items||[]).map(A=>A.size||0),w=x.reduce((A,F)=>A+F,0),y=x.length>0?Math.round(w/x.length):0,b=await a.query({TableName:n.MESSAGES,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e},Limit:1,ScanIndexForward:!0,ProjectionExpression:"timestamp"}).promise(),d=await a.query({TableName:n.MESSAGES,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e},Limit:1,ScanIndexForward:!1,ProjectionExpression:"timestamp"}).promise(),P=b.Items&&b.Items.length>0?b.Items[0].timestamp:0,U=d.Items&&d.Items.length>0?d.Items[0].timestamp:0,N=(await a.query({TableName:n.CONSUMER_GROUPS,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e}}).promise()).Items||[],S=0;for(let A of N){let F=A.groupId,v=await a.get({TableName:n.OFFSETS,Key:{groupId:F,topicId:e}}).promise();if(v.Item){let z=v.Item.lastConsumedTimestamp||0,se=v.Item.lastSequenceNumber||0;if(z>i){let re=se,Y=(z-o.createdAt)/(60*60*1e3);Y>0&&(S+=re/(Y*60))}}}let G=N.length>0?S/N.length:0;return{topicId:e,name:o.name,messageCount:o.messageCount||0,publishRate:l,consumeRate:G,averageMessageSize:y,oldestMessage:P,newestMessage:U}}catch(t){throw c.error("Error calculating topic metrics",{error:t,topicId:e}),t}},de=async()=>{c.debug("Calculating system metrics");try{let[e,t,o]=await Promise.all([a.scan({TableName:n.TOPICS,Select:"COUNT"}).promise(),a.scan({TableName:n.MESSAGES,Select:"COUNT"}).promise(),a.scan({TableName:n.CONSUMER_GROUPS,Select:"COUNT"}).promise()]),i=e.Count||0,r=t.Count||0,s=o.Count||0,l=Date.now()-60*60*1e3,w=((await a.scan({TableName:n.MESSAGES,FilterExpression:"#ts >= :ts",ExpressionAttributeNames:{"#ts":"timestamp"},ExpressionAttributeValues:{":ts":l},Select:"COUNT"}).promise()).Count||0)/60,y=0,d=(await a.scan({TableName:n.OFFSETS,Limit:100}).promise()).Items||[];for(let S of d)S.lastConsumedTimestamp>l&&(y+=S.lastSequenceNumber||0);let P=d.length>0?y/d.length/60:0,U=0,N=((await a.scan({TableName:n.MESSAGES,Limit:100,ProjectionExpression:"size"}).promise()).Items||[]).map(S=>S.size||0);return N.length>0&&(U=N.reduce((G,A)=>G+A,0)/N.length*r),{totalTopics:i,totalMessages:r,totalConsumerGroups:s,averagePublishRate:w,averageConsumeRate:P,storageUsed:U}}catch(e){throw c.error("Error calculating system metrics",{error:e}),e}},Ne=async(e=[],t)=>{try{let o=new Date,i=[];for(let s of e)i.push({MetricName:"MessageCount",Dimensions:[{Name:"TopicId",Value:s.topicId},{Name:"TopicName",Value:s.name}],Value:s.messageCount,Timestamp:o,Unit:"Count"},{MetricName:"PublishRate",Dimensions:[{Name:"TopicId",Value:s.topicId},{Name:"TopicName",Value:s.name}],Value:s.publishRate,Timestamp:o,Unit:"Count/Minute"},{MetricName:"ConsumeRate",Dimensions:[{Name:"TopicId",Value:s.topicId},{Name:"TopicName",Value:s.name}],Value:s.consumeRate,Timestamp:o,Unit:"Count/Minute"},{MetricName:"AverageMessageSize",Dimensions:[{Name:"TopicId",Value:s.topicId},{Name:"TopicName",Value:s.name}],Value:s.averageMessageSize,Timestamp:o,Unit:"Bytes"});t&&i.push({MetricName:"TotalTopics",Value:t.totalTopics,Timestamp:o,Unit:"Count"},{MetricName:"TotalMessages",Value:t.totalMessages,Timestamp:o,Unit:"Count"},{MetricName:"TotalConsumerGroups",Value:t.totalConsumerGroups,Timestamp:o,Unit:"Count"},{MetricName:"AveragePublishRate",Value:t.averagePublishRate,Timestamp:o,Unit:"Count/Minute"},{MetricName:"AverageConsumeRate",Value:t.averageConsumeRate,Timestamp:o,Unit:"Count/Minute"},{MetricName:"StorageUsed",Value:t.storageUsed,Timestamp:o,Unit:"Bytes"});let r=20;for(let s=0;s<i.length;s+=r){let l=i.slice(s,s+r);await ge.putMetricData({Namespace:"MicroQueue",MetricData:l}).promise()}}catch(o){c.error("Error pushing metrics to CloudWatch",{error:o})}},R={calculateTopicMetrics:Se,calculateSystemMetrics:de,pushMetricsToCloudWatch:Ne};_();var Ae=async e=>{c.debug("Creating topic",{topicId:e.topicId});try{return await a.put({TableName:n.TOPICS,Item:e,ConditionExpression:"attribute_not_exists(topicId)"}).promise(),e}catch(t){throw c.error("Error creating topic",{error:t,topic:e}),t.code==="ConditionalCheckFailedException"?g.topicAlreadyExists(e.name):t}},$=async e=>{c.debug("Getting topic",{topicId:e});try{let t=await a.get({TableName:n.TOPICS,Key:{topicId:e}}).promise();if(!t.Item)throw g.topicNotFound(e);return t.Item}catch(t){throw c.error("Error getting topic",{error:t,topicId:e}),t.code==="ResourceNotFoundException"?g.topicNotFound(e):t}},Re=async e=>{c.debug("Getting topic by name",{name:e});try{let t=await a.scan({TableName:n.TOPICS,FilterExpression:"#name = :name",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e},Limit:1}).promise();return t.Items&&t.Items.length>0?t.Items[0]:null}catch(t){throw c.error("Error getting topic by name",{error:t,name:e}),t}},Oe=async()=>{c.debug("Listing topics");try{return(await a.scan({TableName:n.TOPICS}).promise()).Items||[]}catch(e){throw c.error("Error listing topics",{error:e}),e}},Ce=async e=>{c.debug("Deleting topic",{topicId:e});try{await a.delete({TableName:n.TOPICS,Key:{topicId:e},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(t){throw c.error("Error deleting topic",{error:t,topicId:e}),t.code==="ConditionalCheckFailedException"?g.topicNotFound(e):t}},_e=async(e,t)=>{c.debug("Incrementing topic message count",{topicId:e,timestamp:t});try{await a.update({TableName:n.TOPICS,Key:{topicId:e},UpdateExpression:"SET messageCount = messageCount + :inc, lastMessageTimestamp = :ts",ExpressionAttributeValues:{":inc":1,":ts":t},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(o){throw c.error("Error incrementing message count",{error:o,topicId:e}),o.code==="ConditionalCheckFailedException"?g.topicNotFound(e):o}},Me=async(e,t)=>{c.debug("Updating topic",{topicId:e,updates:t});let o=[],i={},r={};if(Object.entries(t).forEach(([s,l])=>{l!==void 0&&(o.push(`#${s} = :${s}`),i[`#${s}`]=s,r[`:${s}`]=l)}),o.length===0)return $(e);try{return await a.update({TableName:n.TOPICS,Key:{topicId:e},UpdateExpression:`SET ${o.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:r,ConditionExpression:"attribute_exists(topicId)",ReturnValues:"NONE"}).promise(),$(e)}catch(s){throw c.error("Error updating topic",{error:s,topicId:e}),s.code==="ConditionalCheckFailedException"?g.topicNotFound(e):s}},f={createTopic:Ae,getTopic:$,getTopicByName:Re,listTopics:Oe,deleteTopic:Ce,incrementMessageCount:_e,updateTopic:Me};var Ie=async e=>(E.debug("Getting topic metrics",{topicId:e}),await f.getTopic(e),R.calculateTopicMetrics(e)),fe=async()=>{E.debug("Getting all topic metrics");let t=(await f.listTopics()).map(o=>R.calculateTopicMetrics(o.topicId));return Promise.all(t)},X=async()=>(E.debug("Getting system metrics"),R.calculateSystemMetrics()),xe=async()=>{E.debug("Collecting and publishing metrics");try{let e=await X(),o=(await f.listTopics()).slice(0,10),i=await Promise.all(o.map(r=>R.calculateTopicMetrics(r.topicId)));await R.pushMetricsToCloudWatch(i,e),E.info("Metrics published successfully")}catch(e){E.error("Error collecting and publishing metrics",{error:e})}},ye=async()=>{E.debug("Getting dashboard metrics");let e=await X(),o=(await f.listTopics()).slice(0,20),i=await Promise.all(o.map(r=>R.calculateTopicMetrics(r.topicId)));return i.sort((r,s)=>s.messageCount-r.messageCount),{system:e,topics:i}},ee={getTopicMetrics:Ie,getAllTopicMetrics:fe,getSystemMetrics:X,collectAndPublishMetrics:xe,getDashboardMetrics:ye};var be=async(e,t)=>{E.info("Starting metrics aggregation",{event:e});try{return await ee.collectAndPublishMetrics(),E.info("Metrics aggregation completed"),{success:!0}}catch(o){return E.error("Error during metrics aggregation",{error:o}),{success:!1}}};0&&(module.exports={handler});
//# sourceMappingURL=metrics-aggregator.js.map
