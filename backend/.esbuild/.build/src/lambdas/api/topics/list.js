"use strict";var le=Object.create;var y=Object.defineProperty;var ue=Object.getOwnPropertyDescriptor;var de=Object.getOwnPropertyNames;var Te=Object.getPrototypeOf,ge=Object.prototype.hasOwnProperty;var D=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),_e=(e,t)=>{for(var r in t)y(e,r,{get:t[r],enumerable:!0})},F=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of de(t))!ge.call(e,n)&&n!==r&&y(e,n,{get:()=>t[n],enumerable:!(i=ue(t,n))||i.enumerable});return e};var M=(e,t,r)=>(r=e!=null?le(Te(e)):{},F(t||!e||!e.__esModule?y(r,"default",{value:e,enumerable:!0}):r,e)),me=e=>F(y({},"__esModule",{value:!0}),e);var Y=D((it,B)=>{var fe="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";B.exports={urlAlphabet:fe}});var J=D((st,Q)=>{var X=require("crypto"),{urlAlphabet:H}=Y(),Ae=128,N,O,j=e=>{!N||N.length<e?(N=Buffer.allocUnsafe(e*Ae),X.randomFillSync(N),O=0):O+e>N.length&&(X.randomFillSync(N),O=0),O+=e},K=e=>(j(e|=0),N.subarray(O-e,O)),k=(e,t,r)=>{let i=(2<<31-Math.clz32(e.length-1|1))-1,n=Math.ceil(1.6*i*t/e.length);return(o=t)=>{let s="";for(;;){let c=r(n),d=n;for(;d--;)if(s+=e[c[d]&i]||"",s.length===o)return s}}},Ne=(e,t=21)=>k(e,t,K),Oe=(e=21)=>{j(e|=0);let t="";for(let r=O-e;r<O;r++)t+=H[N[r]&63];return t};Q.exports={nanoid:Oe,customAlphabet:Ne,customRandom:k,urlAlphabet:H,random:K}});var ee=D((gt,he)=>{he.exports={name:"dotenv",version:"16.4.7",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var C=D((_t,m)=>{var b=require("fs"),P=require("path"),ve=require("os"),Ie=require("crypto"),ye=ee(),U=ye.version,De=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Me(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let i;for(;(i=De.exec(r))!=null;){let n=i[1],o=i[2]||"";o=o.trim();let s=o[0];o=o.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),s==='"'&&(o=o.replace(/\\n/g,`
`),o=o.replace(/\\r/g,"\r")),t[n]=o}return t}function xe(e){let t=oe(e),r=p.configDotenv({path:t});if(!r.parsed){let s=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw s.code="MISSING_DATA",s}let i=re(e).split(","),n=i.length,o;for(let s=0;s<n;s++)try{let c=i[s].trim(),d=we(r,c);o=p.decrypt(d.ciphertext,d.key);break}catch(c){if(s+1>=n)throw c}return p.parse(o)}function Ce(e){console.log(`[dotenv@${U}][INFO] ${e}`)}function Le(e){console.log(`[dotenv@${U}][WARN] ${e}`)}function x(e){console.log(`[dotenv@${U}][DEBUG] ${e}`)}function re(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function we(e,t){let r;try{r=new URL(t)}catch(c){if(c.code==="ERR_INVALID_URL"){let d=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw d.code="INVALID_DOTENV_KEY",d}throw c}let i=r.password;if(!i){let c=new Error("INVALID_DOTENV_KEY: Missing key part");throw c.code="INVALID_DOTENV_KEY",c}let n=r.searchParams.get("environment");if(!n){let c=new Error("INVALID_DOTENV_KEY: Missing environment part");throw c.code="INVALID_DOTENV_KEY",c}let o=`DOTENV_VAULT_${n.toUpperCase()}`,s=e.parsed[o];if(!s){let c=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${o} in your .env.vault file.`);throw c.code="NOT_FOUND_DOTENV_ENVIRONMENT",c}return{ciphertext:s,key:i}}function oe(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)b.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=P.resolve(process.cwd(),".env.vault");return b.existsSync(t)?t:null}function te(e){return e[0]==="~"?P.join(ve.homedir(),e.slice(1)):e}function be(e){Ce("Loading env from encrypted .env.vault");let t=p._parseVault(e),r=process.env;return e&&e.processEnv!=null&&(r=e.processEnv),p.populate(r,t,e),{parsed:t}}function Pe(e){let t=P.resolve(process.cwd(),".env"),r="utf8",i=Boolean(e&&e.debug);e&&e.encoding?r=e.encoding:i&&x("No encoding is specified. UTF-8 is used by default");let n=[t];if(e&&e.path)if(!Array.isArray(e.path))n=[te(e.path)];else{n=[];for(let d of e.path)n.push(te(d))}let o,s={};for(let d of n)try{let h=p.parse(b.readFileSync(d,{encoding:r}));p.populate(s,h,e)}catch(h){i&&x(`Failed to load ${d} ${h.message}`),o=h}let c=process.env;return e&&e.processEnv!=null&&(c=e.processEnv),p.populate(c,s,e),o?{parsed:s,error:o}:{parsed:s}}function Ue(e){if(re(e).length===0)return p.configDotenv(e);let t=oe(e);return t?p._configVault(e):(Le(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),p.configDotenv(e))}function Ge(e,t){let r=Buffer.from(t.slice(-64),"hex"),i=Buffer.from(e,"base64"),n=i.subarray(0,12),o=i.subarray(-16);i=i.subarray(12,-16);try{let s=Ie.createDecipheriv("aes-256-gcm",r,n);return s.setAuthTag(o),`${s.update(i)}${s.final()}`}catch(s){let c=s instanceof RangeError,d=s.message==="Invalid key length",h=s.message==="Unsupported state or unable to authenticate data";if(c||d){let I=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw I.code="INVALID_DOTENV_KEY",I}else if(h){let I=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw I.code="DECRYPTION_FAILED",I}else throw s}}function Ve(e,t,r={}){let i=Boolean(r&&r.debug),n=Boolean(r&&r.override);if(typeof t!="object"){let o=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw o.code="OBJECT_REQUIRED",o}for(let o of Object.keys(t))Object.prototype.hasOwnProperty.call(e,o)?(n===!0&&(e[o]=t[o]),i&&x(n===!0?`"${o}" is already defined and WAS overwritten`:`"${o}" is already defined and was NOT overwritten`)):e[o]=t[o]}var p={configDotenv:Pe,_configVault:be,_parseVault:xe,config:Ue,decrypt:Ge,parse:Me,populate:Ve};m.exports.configDotenv=p.configDotenv;m.exports._configVault=p._configVault;m.exports._parseVault=p._parseVault;m.exports.config=p.config;m.exports.decrypt=p.decrypt;m.exports.parse=p.parse;m.exports.populate=p.populate;m.exports=p});var ot={};_e(ot,{handler:()=>rt});module.exports=me(ot);var q=M(J());var v={DEV:"dev",STAGING:"staging",PROD:"prod"},_=process.env.STAGE||v.DEV,S={TOPICS:process.env.TOPICS_TABLE||`MicroQueue-Topics-${_}`,MESSAGES:process.env.MESSAGES_TABLE||`MicroQueue-Messages-${_}`,CONSUMER_GROUPS:process.env.CONSUMER_GROUPS_TABLE||`MicroQueue-ConsumerGroups-${_}`,OFFSETS:process.env.OFFSETS_TABLE||`MicroQueue-Offsets-${_}`},at={MESSAGES:process.env.MESSAGES_BUCKET||`microqueue-messages-${_}`,ARCHIVE:process.env.ARCHIVE_BUCKET||`microqueue-archive-${_}`},E={MAX_TOPIC_NAME_LENGTH:100,MAX_DESCRIPTION_LENGTH:500,MAX_MESSAGE_SIZE_BYTES:256*1024,MAX_METADATA_KEYS:10,MAX_METADATA_KEY_LENGTH:128,MAX_METADATA_VALUE_LENGTH:256,MAX_RETENTION_HOURS:7*24,DEFAULT_RETENTION_HOURS:24,MAX_MESSAGES_PER_CONSUME:100,DEFAULT_MESSAGES_PER_CONSUME:10,MAX_WAIT_TIME_SECONDS:20,DEFAULT_WAIT_TIME_SECONDS:0},T={INTERNAL_ERROR:"INTERNAL_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",RESOURCE_NOT_FOUND:"RESOURCE_NOT_FOUND",TOPIC_NOT_FOUND:"TOPIC_NOT_FOUND",TOPIC_ALREADY_EXISTS:"TOPIC_ALREADY_EXISTS",MESSAGE_NOT_FOUND:"MESSAGE_NOT_FOUND",MESSAGE_TOO_LARGE:"MESSAGE_TOO_LARGE",INVALID_MESSAGE_FORMAT:"INVALID_MESSAGE_FORMAT",CONSUMER_GROUP_NOT_FOUND:"CONSUMER_GROUP_NOT_FOUND",CONSUMER_GROUP_ALREADY_EXISTS:"CONSUMER_GROUP_ALREADY_EXISTS",RATE_LIMIT_EXCEEDED:"RATE_LIMIT_EXCEEDED",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE"},g={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,CONFLICT:409,PAYLOAD_TOO_LARGE:413,UNPROCESSABLE_ENTITY:422,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,SERVICE_UNAVAILABLE:503};var l=class extends Error{constructor(r,i,n,o){super(i);this.code=r,this.statusCode=n,this.details=o,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,l)}toResponse(){return{success:!1,error:{code:this.code,message:this.message,details:this.details}}}},a={internalError:(e="An internal server error occurred",t)=>new l(T.INTERNAL_ERROR,e,g.INTERNAL_SERVER_ERROR,t),validationError:(e="Validation error",t)=>new l(T.VALIDATION_ERROR,e,g.BAD_REQUEST,t),resourceNotFound:(e,t)=>new l(T.RESOURCE_NOT_FOUND,`${e} with id '${t}' not found`,g.NOT_FOUND),topicNotFound:e=>new l(T.TOPIC_NOT_FOUND,`Topic '${e}' not found`,g.NOT_FOUND),topicAlreadyExists:e=>new l(T.TOPIC_ALREADY_EXISTS,`Topic with name '${e}' already exists`,g.CONFLICT),messageNotFound:e=>new l(T.MESSAGE_NOT_FOUND,`Message '${e}' not found`,g.NOT_FOUND),messageTooLarge:(e,t)=>new l(T.MESSAGE_TOO_LARGE,`Message size (${e} bytes) exceeds maximum allowed size (${t} bytes)`,g.PAYLOAD_TOO_LARGE),consumerGroupNotFound:e=>new l(T.CONSUMER_GROUP_NOT_FOUND,`Consumer group '${e}' not found`,g.NOT_FOUND),consumerGroupAlreadyExists:(e,t)=>new l(T.CONSUMER_GROUP_ALREADY_EXISTS,`Consumer group with name '${e}' already exists for topic '${t}'`,g.CONFLICT),rateLimitExceeded:()=>new l(T.RATE_LIMIT_EXCEEDED,"Rate limit exceeded",g.TOO_MANY_REQUESTS),serviceUnavailable:(e="Service temporarily unavailable")=>new l(T.SERVICE_UNAVAILABLE,e,g.SERVICE_UNAVAILABLE)},W=e=>{if(console.error("Error:",e),e instanceof l)return{statusCode:e.statusCode,body:JSON.stringify(e.toResponse()),headers:{"Content-Type":"application/json"}};if(e.code==="ConditionalCheckFailedException"){let r=a.resourceNotFound("Resource","unknown");return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}if(e.code==="ThrottlingException"){let r=a.rateLimitExceeded();return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}let t=a.internalError(e.message||"An unexpected error occurred");return{statusCode:t.statusCode,body:JSON.stringify(t.toResponse()),headers:{"Content-Type":"application/json"}}};var Se=(e,t=16)=>{let r=(0,q.nanoid)(t);return e?`${e}_${r}`:r},Z=()=>Se("topic");var Re=e=>({success:!0,data:e}),z=(e,t=200)=>({statusCode:t,body:JSON.stringify(Re(e)),headers:{"Content-Type":"application/json"}});var ne=require("aws-sdk"),ie=M(C());ie.config();var se={region:process.env.AWS_REGION||"us-east-1",maxRetries:3,httpOptions:{timeout:5e3},...process.env.IS_LOCAL&&{accessKeyId:"localstack",secretAccessKey:"localstack"}};process.env.DYNAMODB_ENDPOINT&&(console.log(`Using local DynamoDB endpoint: ${process.env.DYNAMODB_ENDPOINT}`),se.endpoint=process.env.DYNAMODB_ENDPOINT);var R=new ne.DynamoDB.DocumentClient(se);var ae=M(C());ae.config();var $e={error:0,warn:1,info:2,debug:3},Fe=process.env.LOG_LEVEL||"info",Be=process.env.LOG_FORMAT||"json",L=$e[Fe]||2,w=(e,t,r)=>{let i=new Date().toISOString(),n=process.env.AWS_REQUEST_ID||"-";if(Be==="json"){let s={timestamp:i,level:e,message:t,requestId:n,service:"MicroQueue-Mini",version:"1.0.0",env:process.env.STAGE||"dev",...r?{data:r}:{}};return JSON.stringify(s)}let o=`[${i}] [${e.toUpperCase()}] [${n}] ${t}`;return r&&(o+=` ${JSON.stringify(r)}`),o},G=class{error(t,r){L>=0&&console.error(w("error",t,r))}warn(t,r){L>=1&&console.warn(w("warn",t,r))}info(t,r){L>=2&&console.info(w("info",t,r))}debug(t,r){L>=3&&console.debug(w("debug",t,r))}},u=new G,f=u;var Ye=async e=>{u.debug("Creating topic",{topicId:e.topicId});try{return await R.put({TableName:S.TOPICS,Item:e,ConditionExpression:"attribute_not_exists(topicId)"}).promise(),e}catch(t){throw u.error("Error creating topic",{error:t,topic:e}),t.code==="ConditionalCheckFailedException"?a.topicAlreadyExists(e.name):t}},V=async e=>{u.debug("Getting topic",{topicId:e});try{let t=await R.get({TableName:S.TOPICS,Key:{topicId:e}}).promise();if(!t.Item)throw a.topicNotFound(e);return t.Item}catch(t){throw u.error("Error getting topic",{error:t,topicId:e}),t.code==="ResourceNotFoundException"?a.topicNotFound(e):t}},Xe=async e=>{u.debug("Getting topic by name",{name:e});try{let t=await R.scan({TableName:S.TOPICS,FilterExpression:"#name = :name",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e},Limit:1}).promise();return t.Items&&t.Items.length>0?t.Items[0]:null}catch(t){throw u.error("Error getting topic by name",{error:t,name:e}),t}},He=async()=>{u.debug("Listing topics");try{return(await R.scan({TableName:S.TOPICS}).promise()).Items||[]}catch(e){throw u.error("Error listing topics",{error:e}),e}},je=async e=>{u.debug("Deleting topic",{topicId:e});try{await R.delete({TableName:S.TOPICS,Key:{topicId:e},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(t){throw u.error("Error deleting topic",{error:t,topicId:e}),t.code==="ConditionalCheckFailedException"?a.topicNotFound(e):t}},Ke=async(e,t)=>{u.debug("Incrementing topic message count",{topicId:e,timestamp:t});try{await R.update({TableName:S.TOPICS,Key:{topicId:e},UpdateExpression:"SET messageCount = messageCount + :inc, lastMessageTimestamp = :ts",ExpressionAttributeValues:{":inc":1,":ts":t},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(r){throw u.error("Error incrementing message count",{error:r,topicId:e}),r.code==="ConditionalCheckFailedException"?a.topicNotFound(e):r}},ke=async(e,t)=>{u.debug("Updating topic",{topicId:e,updates:t});let r=[],i={},n={};if(Object.entries(t).forEach(([o,s])=>{s!==void 0&&(r.push(`#${o} = :${o}`),i[`#${o}`]=o,n[`:${o}`]=s)}),r.length===0)return V(e);try{return await R.update({TableName:S.TOPICS,Key:{topicId:e},UpdateExpression:`SET ${r.join(", ")}`,ExpressionAttributeNames:i,ExpressionAttributeValues:n,ConditionExpression:"attribute_exists(topicId)",ReturnValues:"NONE"}).promise(),V(e)}catch(o){throw u.error("Error updating topic",{error:o,topicId:e}),o.code==="ConditionalCheckFailedException"?a.topicNotFound(e):o}},A={createTopic:Ye,getTopic:V,getTopicByName:Xe,listTopics:He,deleteTopic:je,incrementMessageCount:Ke,updateTopic:ke};var Ee=M(C());Ee.config();var Qe={serviceName:"MicroQueue-Mini",version:"1.0.0",dynamodb:{maxRetries:3,timeout:5e3},s3:{maxRetries:3,timeout:1e4},api:{corsOrigins:"*",rateLimit:{windowMs:60*1e3,max:100}},logging:{level:"info",format:"json"},topics:{maxTopicsPerAccount:100,defaultRetentionHours:E.DEFAULT_RETENTION_HOURS},messages:{maxSizeBytes:E.MAX_MESSAGE_SIZE_BYTES,batchSize:25},consumers:{defaultMaxMessages:E.DEFAULT_MESSAGES_PER_CONSUME,defaultWaitTimeSeconds:E.DEFAULT_WAIT_TIME_SECONDS}},ce={[v.DEV]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:20}},[v.STAGING]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:50}},[v.PROD]:{logging:{level:"info"},topics:{maxTopicsPerAccount:100},api:{rateLimit:{windowMs:60*1e3,max:200}}}},Je=ce[_]||ce[v.DEV],We={...Qe,...Je,env:_},$=We;var qe=async e=>{if(f.debug("Creating topic",{request:e}),!e.name)throw a.validationError("Topic name is required");if(e.name.length>E.MAX_TOPIC_NAME_LENGTH)throw a.validationError(`Topic name cannot exceed ${E.MAX_TOPIC_NAME_LENGTH} characters`);if(e.description&&e.description.length>E.MAX_DESCRIPTION_LENGTH)throw a.validationError(`Topic description cannot exceed ${E.MAX_DESCRIPTION_LENGTH} characters`);let t=e.retentionPeriodHours||E.DEFAULT_RETENTION_HOURS;if(t<1)throw a.validationError("Retention period must be at least 1 hour");if(t>E.MAX_RETENTION_HOURS)throw a.validationError(`Retention period cannot exceed ${E.MAX_RETENTION_HOURS} hours`);if(await A.getTopicByName(e.name))throw a.topicAlreadyExists(e.name);if((await A.listTopics()).length>=$.topics.maxTopicsPerAccount)throw a.validationError(`Maximum number of topics (${$.topics.maxTopicsPerAccount}) reached`);let n={topicId:Z(),name:e.name,description:e.description,createdAt:Date.now(),retentionPeriodHours:t,messageCount:0};return A.createTopic(n)},Ze=async e=>(f.debug("Getting topic",{topicId:e}),A.getTopic(e)),ze=async()=>(f.debug("Listing topics"),A.listTopics()),et=async e=>(f.debug("Deleting topic",{topicId:e}),A.deleteTopic(e)),tt=async(e,t)=>{if(f.debug("Updating topic",{topicId:e,updates:t}),t.name&&t.name.length>E.MAX_TOPIC_NAME_LENGTH)throw a.validationError(`Topic name cannot exceed ${E.MAX_TOPIC_NAME_LENGTH} characters`);if(t.description&&t.description.length>E.MAX_DESCRIPTION_LENGTH)throw a.validationError(`Topic description cannot exceed ${E.MAX_DESCRIPTION_LENGTH} characters`);if(t.retentionPeriodHours){if(t.retentionPeriodHours<1)throw a.validationError("Retention period must be at least 1 hour");if(t.retentionPeriodHours>E.MAX_RETENTION_HOURS)throw a.validationError(`Retention period cannot exceed ${E.MAX_RETENTION_HOURS} hours`)}if(t.name){let r=await A.getTopicByName(t.name);if(r&&r.topicId!==e)throw a.topicAlreadyExists(t.name)}return A.updateTopic(e,t)},pe={createTopic:qe,getTopic:Ze,listTopics:ze,deleteTopic:et,updateTopic:tt};var rt=async e=>{try{f.debug("List topics request",{event:e});let t=await pe.listTopics();return z(t)}catch(t){return f.error("Error listing topics",{error:t}),W(t)}};0&&(module.exports={handler});
//# sourceMappingURL=list.js.map
