"use strict";var _e=Object.create;var w=Object.defineProperty;var Ne=Object.getOwnPropertyDescriptor;var ye=Object.getOwnPropertyNames;var fe=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var V=(e,t)=>()=>(e&&(t=e(e=0)),t);var q=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),X=(e,t)=>{for(var r in t)w(e,r,{get:t[r],enumerable:!0})},K=(e,t,r,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ye(t))!Oe.call(e,i)&&i!==r&&w(e,i,{get:()=>t[i],enumerable:!(s=Ne(t,i))||s.enumerable});return e};var Me=(e,t,r)=>(r=e!=null?_e(fe(e)):{},K(t||!e||!e.__esModule?w(r,"default",{value:e,enumerable:!0}):r,e)),Y=e=>K(w({},"__esModule",{value:!0}),e);var j=q((ct,H)=>{var Ce="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";H.exports={urlAlphabet:Ce}});var ee=q((mt,z)=>{var k=require("crypto"),{urlAlphabet:Q}=j(),xe=128,y,f,W=e=>{!y||y.length<e?(y=Buffer.allocUnsafe(e*xe),k.randomFillSync(y),f=0):f+e>y.length&&(k.randomFillSync(y),f=0),f+=e},J=e=>(W(e|=0),y.subarray(f-e,f)),Z=(e,t,r)=>{let s=(2<<31-Math.clz32(e.length-1|1))-1,i=Math.ceil(1.6*s*t/e.length);return(a=t)=>{let E="";for(;;){let N=r(i),M=i;for(;M--;)if(E+=e[N[M]&s]||"",E.length===a)return E}}},Re=(e,t=21)=>Z(e,t,J),Ie=(e=21)=>{W(e|=0);let t="";for(let r=f-e;r<f;r++)t+=Q[y[r]&63];return t};z.exports={nanoid:Ie,customAlphabet:Re,customRandom:Z,urlAlphabet:Q,random:J}});var C,S,c,x,u,d,l,P,A=V(()=>{"use strict";C={DEV:"dev",STAGING:"staging",PROD:"prod"},S=process.env.STAGE||C.DEV,c={TOPICS:process.env.TOPICS_TABLE||`MicroQueue-Topics-${S}`,MESSAGES:process.env.MESSAGES_TABLE||`MicroQueue-Messages-${S}`,CONSUMER_GROUPS:process.env.CONSUMER_GROUPS_TABLE||`MicroQueue-ConsumerGroups-${S}`,OFFSETS:process.env.OFFSETS_TABLE||`MicroQueue-Offsets-${S}`},x={MESSAGES:process.env.MESSAGES_BUCKET||`microqueue-messages-${S}`,ARCHIVE:process.env.ARCHIVE_BUCKET||`microqueue-archive-${S}`},u={MAX_TOPIC_NAME_LENGTH:100,MAX_DESCRIPTION_LENGTH:500,MAX_MESSAGE_SIZE_BYTES:256*1024,MAX_METADATA_KEYS:10,MAX_METADATA_KEY_LENGTH:128,MAX_METADATA_VALUE_LENGTH:256,MAX_RETENTION_HOURS:7*24,DEFAULT_RETENTION_HOURS:24,MAX_MESSAGES_PER_CONSUME:100,DEFAULT_MESSAGES_PER_CONSUME:10,MAX_WAIT_TIME_SECONDS:20,DEFAULT_WAIT_TIME_SECONDS:0},d={INTERNAL_ERROR:"INTERNAL_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",RESOURCE_NOT_FOUND:"RESOURCE_NOT_FOUND",TOPIC_NOT_FOUND:"TOPIC_NOT_FOUND",TOPIC_ALREADY_EXISTS:"TOPIC_ALREADY_EXISTS",MESSAGE_NOT_FOUND:"MESSAGE_NOT_FOUND",MESSAGE_TOO_LARGE:"MESSAGE_TOO_LARGE",INVALID_MESSAGE_FORMAT:"INVALID_MESSAGE_FORMAT",CONSUMER_GROUP_NOT_FOUND:"CONSUMER_GROUP_NOT_FOUND",CONSUMER_GROUP_ALREADY_EXISTS:"CONSUMER_GROUP_ALREADY_EXISTS",RATE_LIMIT_EXCEEDED:"RATE_LIMIT_EXCEEDED",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE"},l={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,CONFLICT:409,PAYLOAD_TOO_LARGE:413,UNPROCESSABLE_ENTITY:422,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,SERVICE_UNAVAILABLE:503},P={JSON:"application/json",TEXT:"text/plain",XML:"application/xml",BINARY:"application/octet-stream"}});var pe={};X(pe,{config:()=>O,default:()=>De});var we,ge,Pe,O,De,D=V(()=>{"use strict";A();we={serviceName:"MicroQueue-Mini",version:"1.0.0",dynamodb:{maxRetries:3,timeout:5e3},s3:{maxRetries:3,timeout:1e4},api:{corsOrigins:"*",rateLimit:{windowMs:60*1e3,max:100}},logging:{level:"info",format:"json"},topics:{maxTopicsPerAccount:100,defaultRetentionHours:u.DEFAULT_RETENTION_HOURS},messages:{maxSizeBytes:u.MAX_MESSAGE_SIZE_BYTES,batchSize:25},consumers:{defaultMaxMessages:u.DEFAULT_MESSAGES_PER_CONSUME,defaultWaitTimeSeconds:u.DEFAULT_WAIT_TIME_SECONDS}},ge={[C.DEV]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:20}},[C.STAGING]:{logging:{level:"debug"},topics:{maxTopicsPerAccount:50}},[C.PROD]:{logging:{level:"info"},topics:{maxTopicsPerAccount:100},api:{rateLimit:{windowMs:60*1e3,max:200}}}},Pe=ge[S]||ge[C.DEV],O={...we,...Pe,env:S},De=O});var at={};X(at,{handler:()=>it});module.exports=Y(at);var re=Me(ee());A();A();var g=class extends Error{constructor(r,s,i,a){super(s);this.code=r,this.statusCode=i,this.details=a,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,g)}toResponse(){return{success:!1,error:{code:this.code,message:this.message,details:this.details}}}},n={internalError:(e="An internal server error occurred",t)=>new g(d.INTERNAL_ERROR,e,l.INTERNAL_SERVER_ERROR,t),validationError:(e="Validation error",t)=>new g(d.VALIDATION_ERROR,e,l.BAD_REQUEST,t),resourceNotFound:(e,t)=>new g(d.RESOURCE_NOT_FOUND,`${e} with id '${t}' not found`,l.NOT_FOUND),topicNotFound:e=>new g(d.TOPIC_NOT_FOUND,`Topic '${e}' not found`,l.NOT_FOUND),topicAlreadyExists:e=>new g(d.TOPIC_ALREADY_EXISTS,`Topic with name '${e}' already exists`,l.CONFLICT),messageNotFound:e=>new g(d.MESSAGE_NOT_FOUND,`Message '${e}' not found`,l.NOT_FOUND),messageTooLarge:(e,t)=>new g(d.MESSAGE_TOO_LARGE,`Message size (${e} bytes) exceeds maximum allowed size (${t} bytes)`,l.PAYLOAD_TOO_LARGE),consumerGroupNotFound:e=>new g(d.CONSUMER_GROUP_NOT_FOUND,`Consumer group '${e}' not found`,l.NOT_FOUND),consumerGroupAlreadyExists:(e,t)=>new g(d.CONSUMER_GROUP_ALREADY_EXISTS,`Consumer group with name '${e}' already exists for topic '${t}'`,l.CONFLICT),rateLimitExceeded:()=>new g(d.RATE_LIMIT_EXCEEDED,"Rate limit exceeded",l.TOO_MANY_REQUESTS),serviceUnavailable:(e="Service temporarily unavailable")=>new g(d.SERVICE_UNAVAILABLE,e,l.SERVICE_UNAVAILABLE)},te=e=>{if(console.error("Error:",e),e instanceof g)return{statusCode:e.statusCode,body:JSON.stringify(e.toResponse()),headers:{"Content-Type":"application/json"}};if(e.code==="ConditionalCheckFailedException"){let r=n.resourceNotFound("Resource","unknown");return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}if(e.code==="ThrottlingException"){let r=n.rateLimitExceeded();return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}let t=n.internalError(e.message||"An unexpected error occurred");return{statusCode:t.statusCode,body:JSON.stringify(t.toResponse()),headers:{"Content-Type":"application/json"}}};var be=(e,t=16)=>{let r=(0,re.nanoid)(t);return e?`${e}_${r}`:r};var oe=()=>be("msg");var se=(e,t)=>{let r=Date.now();return`${e}/${r}/${t}`},ne=e=>{let t=typeof e=="string"?e:JSON.stringify(e),r=Buffer.byteLength(t,"utf8");if(r>u.MAX_MESSAGE_SIZE_BYTES)throw n.messageTooLarge(r,u.MAX_MESSAGE_SIZE_BYTES)},ie=e=>{if(!e)return;let t=Object.keys(e);if(t.length>u.MAX_METADATA_KEYS)throw n.validationError(`Metadata cannot have more than ${u.MAX_METADATA_KEYS} keys`,{field:"metadata"});for(let r of t){if(r.length>u.MAX_METADATA_KEY_LENGTH)throw n.validationError(`Metadata key '${r}' exceeds maximum length of ${u.MAX_METADATA_KEY_LENGTH}`,{field:"metadata",key:r});let s=e[r];if(s&&s.length>u.MAX_METADATA_VALUE_LENGTH)throw n.validationError(`Metadata value for key '${r}' exceeds maximum length of ${u.MAX_METADATA_VALUE_LENGTH}`,{field:"metadata",key:r})}},he=e=>({success:!0,data:e}),ae=(e,t=200)=>({statusCode:t,body:JSON.stringify(he(e)),headers:{"Content-Type":"application/json"}}),ue=(e,t)=>{if(t)return t;if(typeof e=="string")try{return JSON.parse(e),P.JSON}catch{return P.TEXT}return P.JSON},ce=(e,t)=>e+t*60*60*1e3;var me=(e,t)=>{if(!e||!e[t])throw n.validationError(`Path parameter '${t}' is required`);return e[t]},Ee=(e,t,r)=>{if(!e||!e[t]){if(r!==void 0)return r;throw n.validationError(`Query parameter '${t}' is required`)}return e[t]},F=(e,t,r,s)=>{let i=parseInt(e,10);if(isNaN(i))throw n.validationError(`Parameter '${t}' must be a valid integer`);if(r!==void 0&&i<r)throw n.validationError(`Parameter '${t}' must be at least ${r}`);if(s!==void 0&&i>s)throw n.validationError(`Parameter '${t}' must be at most ${s}`);return i};A();A();var de=require("aws-sdk");D();var le={maxRetries:O.dynamodb.maxRetries,httpOptions:{timeout:O.dynamodb.timeout}};process.env.DYNAMODB_ENDPOINT&&(le.endpoint=process.env.DYNAMODB_ENDPOINT);var m=new de.DynamoDB.DocumentClient(le);var Te=require("aws-sdk");D();var v={maxRetries:O.s3.maxRetries,httpOptions:{timeout:O.s3.timeout}};process.env.S3_ENDPOINT&&(v.endpoint=process.env.S3_ENDPOINT,v.s3ForcePathStyle=!0);var I=new Te.S3(v);A();var b=(D(),Y(pe));var Ge={error:0,warn:1,info:2,debug:3},G=Ge[b.logging.level]||2,L=(e,t,r)=>{let s=new Date().toISOString(),i=process.env.AWS_REQUEST_ID||"-";if(b.logging.format==="json"){let E={timestamp:s,level:e,message:t,requestId:i,service:b.serviceName,version:b.version,env:b.env,...r?{data:r}:{}};return JSON.stringify(E)}let a=`[${s}] [${e.toUpperCase()}] [${i}] ${t}`;return r&&(a+=` ${JSON.stringify(r)}`),a},B=class{error(t,r){G>=0&&console.error(L("error",t,r))}warn(t,r){G>=1&&console.warn(L("warn",t,r))}info(t,r){G>=2&&console.info(L("info",t,r))}debug(t,r){G>=3&&console.debug(L("debug",t,r))}},o=new B,_=o;var Le=async(e,t)=>{o.debug("Storing message",{messageId:e.messageId,topicId:e.topicId});try{return await I.putObject({Bucket:x.MESSAGES,Key:e.payloadKey,Body:t,ContentType:e.contentType}).promise(),await m.put({TableName:c.MESSAGES,Item:e}).promise(),e}catch(r){throw o.error("Error storing message",{error:r,message:e}),r}},Ue=async e=>{o.debug("Getting message by ID",{messageId:e});try{let t=await m.query({TableName:c.MESSAGES,IndexName:"MessageIdIndex",KeyConditionExpression:"messageId = :messageId",ExpressionAttributeValues:{":messageId":e},Limit:1}).promise();if(!t.Items||t.Items.length===0)throw n.messageNotFound(e);return t.Items[0]}catch(t){throw o.error("Error getting message by ID",{error:t,messageId:e}),t.code==="ResourceNotFoundException"?n.messageNotFound(e):t}},Fe=async(e,t,r)=>{o.debug("Getting messages",{topicId:e,fromSequence:t,limit:r});try{return(await m.query({TableName:c.MESSAGES,KeyConditionExpression:"topicId = :topicId AND sequenceNumber > :seq",ExpressionAttributeValues:{":topicId":e,":seq":t},Limit:r,ScanIndexForward:!0}).promise()).Items||[]}catch(s){throw o.error("Error getting messages",{error:s,topicId:e,fromSequence:t}),s}},ve=async e=>{o.debug("Getting message payload",{payloadKey:e});try{return(await I.getObject({Bucket:x.MESSAGES,Key:e}).promise()).Body}catch(t){throw o.error("Error getting message payload",{error:t,payloadKey:e}),t.code==="NoSuchKey"?n.resourceNotFound("Message payload",e):t}},Be=async e=>{o.debug("Deleting message",{messageId:e.messageId,topicId:e.topicId});try{await m.delete({TableName:c.MESSAGES,Key:{topicId:e.topicId,sequenceNumber:e.sequenceNumber}}).promise(),await I.copyObject({Bucket:x.ARCHIVE,Key:e.payloadKey,CopySource:`${x.MESSAGES}/${e.payloadKey}`}).promise(),await I.deleteObject({Bucket:x.MESSAGES,Key:e.payloadKey}).promise()}catch(t){throw o.error("Error deleting message",{error:t,message:e}),t}},$e=async e=>{o.debug("Getting next sequence number",{topicId:e});try{let t=await m.query({TableName:c.MESSAGES,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e},Limit:1,ScanIndexForward:!1}).promise();return!t.Items||t.Items.length===0?1:t.Items[0].sequenceNumber+1}catch(t){throw o.error("Error getting next sequence number",{error:t,topicId:e}),t}},Ve=async e=>{o.debug("Finding expired messages",{batchSize:e});try{let t=Math.floor(Date.now()/1e3);return(await m.scan({TableName:c.MESSAGES,FilterExpression:"expiresAt < :now",ExpressionAttributeValues:{":now":t},Limit:e}).promise()).Items||[]}catch(t){throw o.error("Error finding expired messages",{error:t}),t}},T={storeMessage:Le,getMessageById:Ue,getMessages:Fe,getMessagePayload:ve,deleteMessage:Be,getNextSequenceNumber:$e,findExpiredMessages:Ve};A();var qe=async e=>{o.debug("Creating topic",{topicId:e.topicId});try{return await m.put({TableName:c.TOPICS,Item:e,ConditionExpression:"attribute_not_exists(topicId)"}).promise(),e}catch(t){throw o.error("Error creating topic",{error:t,topic:e}),t.code==="ConditionalCheckFailedException"?n.topicAlreadyExists(e.name):t}},$=async e=>{o.debug("Getting topic",{topicId:e});try{let t=await m.get({TableName:c.TOPICS,Key:{topicId:e}}).promise();if(!t.Item)throw n.topicNotFound(e);return t.Item}catch(t){throw o.error("Error getting topic",{error:t,topicId:e}),t.code==="ResourceNotFoundException"?n.topicNotFound(e):t}},Xe=async e=>{o.debug("Getting topic by name",{name:e});try{let t=await m.scan({TableName:c.TOPICS,FilterExpression:"#name = :name",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e},Limit:1}).promise();return t.Items&&t.Items.length>0?t.Items[0]:null}catch(t){throw o.error("Error getting topic by name",{error:t,name:e}),t}},Ke=async()=>{o.debug("Listing topics");try{return(await m.scan({TableName:c.TOPICS}).promise()).Items||[]}catch(e){throw o.error("Error listing topics",{error:e}),e}},Ye=async e=>{o.debug("Deleting topic",{topicId:e});try{await m.delete({TableName:c.TOPICS,Key:{topicId:e},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(t){throw o.error("Error deleting topic",{error:t,topicId:e}),t.code==="ConditionalCheckFailedException"?n.topicNotFound(e):t}},He=async(e,t)=>{o.debug("Incrementing topic message count",{topicId:e,timestamp:t});try{await m.update({TableName:c.TOPICS,Key:{topicId:e},UpdateExpression:"SET messageCount = messageCount + :inc, lastMessageTimestamp = :ts",ExpressionAttributeValues:{":inc":1,":ts":t},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(r){throw o.error("Error incrementing message count",{error:r,topicId:e}),r.code==="ConditionalCheckFailedException"?n.topicNotFound(e):r}},je=async(e,t)=>{o.debug("Updating topic",{topicId:e,updates:t});let r=[],s={},i={};if(Object.entries(t).forEach(([a,E])=>{E!==void 0&&(r.push(`#${a} = :${a}`),s[`#${a}`]=a,i[`:${a}`]=E)}),r.length===0)return $(e);try{return await m.update({TableName:c.TOPICS,Key:{topicId:e},UpdateExpression:`SET ${r.join(", ")}`,ExpressionAttributeNames:s,ExpressionAttributeValues:i,ConditionExpression:"attribute_exists(topicId)",ReturnValues:"NONE"}).promise(),$(e)}catch(a){throw o.error("Error updating topic",{error:a,topicId:e}),a.code==="ConditionalCheckFailedException"?n.topicNotFound(e):a}},U={createTopic:qe,getTopic:$,getTopicByName:Xe,listTopics:Ke,deleteTopic:Ye,incrementMessageCount:He,updateTopic:je};A();var ke=async e=>{o.debug("Creating consumer group",{groupId:e.groupId,topicId:e.topicId});try{return await m.put({TableName:c.CONSUMER_GROUPS,Item:e,ConditionExpression:"attribute_not_exists(groupId) AND attribute_not_exists(topicId)"}).promise(),e}catch(t){throw o.error("Error creating consumer group",{error:t,consumerGroup:e}),t.code==="ConditionalCheckFailedException"?n.consumerGroupAlreadyExists(e.name,e.topicId):t}},Qe=async(e,t)=>{o.debug("Getting consumer group",{groupId:e,topicId:t});try{let r=await m.get({TableName:c.CONSUMER_GROUPS,Key:{groupId:e,topicId:t}}).promise();if(!r.Item)throw n.consumerGroupNotFound(e);return r.Item}catch(r){throw o.error("Error getting consumer group",{error:r,groupId:e,topicId:t}),r.code==="ResourceNotFoundException"?n.consumerGroupNotFound(e):r}},We=async(e,t)=>{o.debug("Getting consumer group by name",{name:e,topicId:t});try{let r=await m.scan({TableName:c.CONSUMER_GROUPS,FilterExpression:"#name = :name AND topicId = :topicId",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e,":topicId":t},Limit:1}).promise();return r.Items&&r.Items.length>0?r.Items[0]:null}catch(r){throw o.error("Error getting consumer group by name",{error:r,name:e,topicId:t}),r}},Je=async e=>{o.debug("Listing consumer groups",{topicId:e});try{return(await m.query({TableName:c.CONSUMER_GROUPS,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e}}).promise()).Items||[]}catch(t){throw o.error("Error listing consumer groups",{error:t,topicId:e}),t}},Ze=async(e,t)=>{o.debug("Deleting consumer group",{groupId:e,topicId:t});try{await m.delete({TableName:c.CONSUMER_GROUPS,Key:{groupId:e,topicId:t},ConditionExpression:"attribute_exists(groupId) AND attribute_exists(topicId)"}).promise(),await m.delete({TableName:c.OFFSETS,Key:{groupId:e,topicId:t}}).promise()}catch(r){throw o.error("Error deleting consumer group",{error:r,groupId:e,topicId:t}),r.code==="ConditionalCheckFailedException"?n.consumerGroupNotFound(e):r}},ze=async(e,t,r)=>{o.debug("Updating consumer group timestamp",{groupId:e,topicId:t,timestamp:r});try{await m.update({TableName:c.CONSUMER_GROUPS,Key:{groupId:e,topicId:t},UpdateExpression:"SET lastConsumedTimestamp = :ts",ExpressionAttributeValues:{":ts":r},ConditionExpression:"attribute_exists(groupId) AND attribute_exists(topicId)"}).promise()}catch(s){throw o.error("Error updating consumer group timestamp",{error:s,groupId:e,topicId:t}),s.code==="ConditionalCheckFailedException"?n.consumerGroupNotFound(e):s}},et=async(e,t)=>{o.debug("Getting consumer offset",{groupId:e,topicId:t});try{let r=await m.get({TableName:c.OFFSETS,Key:{groupId:e,topicId:t}}).promise();return r.Item?r.Item:null}catch(r){throw o.error("Error getting consumer offset",{error:r,groupId:e,topicId:t}),r}},tt=async e=>{o.debug("Updating consumer offset",{groupId:e.groupId,topicId:e.topicId,sequenceNumber:e.lastSequenceNumber});try{await m.put({TableName:c.OFFSETS,Item:e}).promise()}catch(t){throw o.error("Error updating consumer offset",{error:t,offset:e}),t}},h={createConsumerGroup:ke,getConsumerGroup:Qe,getConsumerGroupByName:We,listConsumerGroups:Je,deleteConsumerGroup:Ze,updateConsumerGroupTimestamp:ze,getConsumerOffset:et,updateConsumerOffset:tt};var rt=async(e,t)=>{if(_.debug("Publishing message",{topicId:e}),!t.payload)throw n.validationError("Message payload is required");ne(t.payload),ie(t.metadata);let r=await U.getTopic(e),s=await T.getNextSequenceNumber(e),i=ue(t.payload,t.contentType),a=oe(),E=se(e,a),N=typeof t.payload=="string"?t.payload:JSON.stringify(t.payload),M=Buffer.byteLength(N,"utf8"),p=Date.now(),R=Math.floor(ce(p,r.retentionPeriodHours)/1e3),Ae={messageId:a,topicId:e,timestamp:p,sequenceNumber:s,payloadKey:E,contentType:i,size:M,metadata:t.metadata,expiresAt:R};return await T.storeMessage(Ae,N),await U.incrementMessageCount(e,p),{messageId:a,topicId:e,timestamp:p,sequenceNumber:s}},ot=async(e,t)=>{if(_.debug("Consuming messages",{topicId:e,request:t}),!t.consumerGroupId)throw n.validationError("Consumer group ID is required");let r=t.maxMessages||u.DEFAULT_MESSAGES_PER_CONSUME;if(r<1)throw n.validationError("Max messages must be at least 1");if(r>u.MAX_MESSAGES_PER_CONSUME)throw n.validationError(`Max messages cannot exceed ${u.MAX_MESSAGES_PER_CONSUME}`);let s=t.waitTimeSeconds||u.DEFAULT_WAIT_TIME_SECONDS;if(s<0)throw n.validationError("Wait time cannot be negative");if(s>u.MAX_WAIT_TIME_SECONDS)throw n.validationError(`Wait time cannot exceed ${u.MAX_WAIT_TIME_SECONDS} seconds`);await U.getTopic(e),await h.getConsumerGroup(t.consumerGroupId,e);let i=0,a=await h.getConsumerOffset(t.consumerGroupId,e);a&&(i=a.lastSequenceNumber);let E=await T.getMessages(e,i,r);if(E.length===0&&s>0){let p=Date.now()+s*1e3;for(;E.length===0&&Date.now()<p;)await new Promise(R=>setTimeout(R,500)),E=await T.getMessages(e,i,r)}if(E.length===0)return{messages:[],nextSequenceNumber:i};let N=await Promise.all(E.map(async p=>{let R=await T.getMessagePayload(p.payloadKey);return{messageId:p.messageId,payload:R.toString("utf8"),timestamp:p.timestamp,sequenceNumber:p.sequenceNumber,contentType:p.contentType,metadata:p.metadata}})),M=E[E.length-1];return await h.updateConsumerOffset({groupId:t.consumerGroupId,topicId:e,lastSequenceNumber:M.sequenceNumber,lastConsumedTimestamp:Date.now()}),await h.updateConsumerGroupTimestamp(t.consumerGroupId,e,Date.now()),{messages:N,nextSequenceNumber:M.sequenceNumber+1}},st=async e=>{_.debug("Getting message by ID",{messageId:e});let t=await T.getMessageById(e),r=await T.getMessagePayload(t.payloadKey);return{message:t,payload:r.toString("utf8")}},nt=async e=>{_.debug("Cleaning up expired messages",{batchSize:e});let t=await T.findExpiredMessages(e);if(t.length===0)return 0;let r=0;for(let s of t)try{await T.deleteMessage(s),r++}catch(i){_.error("Error deleting expired message",{error:i,messageId:s.messageId})}return r},Se={publishMessage:rt,consumeMessages:ot,getMessageById:st,cleanupExpiredMessages:nt};var it=async e=>{try{_.debug("Consume messages request",{event:e});let t=me(e.pathParameters,"topicId"),r=e.queryStringParameters,s=Ee(r,"consumerGroupId"),i=u.DEFAULT_MESSAGES_PER_CONSUME,a=u.DEFAULT_WAIT_TIME_SECONDS;e.queryStringParameters&&(e.queryStringParameters.maxMessages&&(i=F(e.queryStringParameters.maxMessages,"maxMessages",1,u.MAX_MESSAGES_PER_CONSUME)),e.queryStringParameters.waitTimeSeconds&&(a=F(e.queryStringParameters.waitTimeSeconds,"waitTimeSeconds",0,u.MAX_WAIT_TIME_SECONDS)));let E={consumerGroupId:s,maxMessages:i,waitTimeSeconds:a},N=await Se.consumeMessages(t,E);return ae(N)}catch(t){return _.error("Error consuming messages",{error:t}),te(t)}};0&&(module.exports={handler});
//# sourceMappingURL=consume.js.map
