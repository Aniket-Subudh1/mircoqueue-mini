"use strict";var he=Object.create;var b=Object.defineProperty;var Me=Object.getOwnPropertyDescriptor;var Ie=Object.getOwnPropertyNames;var Re=Object.getPrototypeOf,Ce=Object.prototype.hasOwnProperty;var w=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),xe=(e,t)=>{for(var r in t)b(e,r,{get:t[r],enumerable:!0})},k=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of Ie(t))!Ce.call(e,n)&&n!==r&&b(e,n,{get:()=>t[n],enumerable:!(o=Me(t,n))||o.enumerable});return e};var D=(e,t,r)=>(r=e!=null?he(Re(e)):{},k(t||!e||!e.__esModule?b(r,"default",{value:e,enumerable:!0}):r,e)),be=e=>k(b({},"__esModule",{value:!0}),e);var X=w((bt,j)=>{var we="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";j.exports={urlAlphabet:we}});var ee=w((wt,z)=>{var W=require("crypto"),{urlAlphabet:H}=X(),De=128,O,h,Q=e=>{!O||O.length<e?(O=Buffer.allocUnsafe(e*De),W.randomFillSync(O),h=0):h+e>O.length&&(W.randomFillSync(O),h=0),h+=e},J=e=>(Q(e|=0),O.subarray(h-e,h)),Z=(e,t,r)=>{let o=(2<<31-Math.clz32(e.length-1|1))-1,n=Math.ceil(1.6*o*t/e.length);return(s=t)=>{let a="";for(;;){let u=r(n),l=n;for(;l--;)if(a+=e[u[l]&o]||"",a.length===s)return a}}},ve=(e,t=21)=>Z(e,t,J),Pe=(e=21)=>{Q(e|=0);let t="";for(let r=h-e;r<h;r++)t+=H[O[r]&63];return t};z.exports={nanoid:Pe,customAlphabet:ve,customRandom:Z,urlAlphabet:H,random:J}});var Ee=w((Ft,Fe)=>{Fe.exports={name:"dotenv",version:"16.4.7",description:"Loads environment variables from .env file",main:"lib/main.js",types:"lib/main.d.ts",exports:{".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},scripts:{"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard",pretest:"npm run lint && npm run dts-check",test:"tap run --allow-empty-coverage --disable-coverage --timeout=60000","test:coverage":"tap run --show-full-coverage --timeout=60000 --coverage-report=lcov",prerelease:"npm test",release:"standard-version"},repository:{type:"git",url:"git://github.com/motdotla/dotenv.git"},funding:"https://dotenvx.com",keywords:["dotenv","env",".env","environment","variables","config","settings"],readmeFilename:"README.md",license:"BSD-2-Clause",devDependencies:{"@types/node":"^18.11.3",decache:"^4.6.2",sinon:"^14.0.1",standard:"^17.0.0","standard-version":"^9.5.0",tap:"^19.2.0",typescript:"^4.8.4"},engines:{node:">=12"},browser:{fs:!1}}});var L=w((Vt,N)=>{var $=require("fs"),B=require("path"),Ve=require("os"),$e=require("crypto"),Be=Ee(),K=Be.version,Ke=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function Ye(e){let t={},r=e.toString();r=r.replace(/\r\n?/mg,`
`);let o;for(;(o=Ke.exec(r))!=null;){let n=o[1],s=o[2]||"";s=s.trim();let a=s[0];s=s.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),a==='"'&&(s=s.replace(/\\n/g,`
`),s=s.replace(/\\r/g,"\r")),t[n]=s}return t}function qe(e){let t=de(e),r=d.configDotenv({path:t});if(!r.parsed){let a=new Error(`MISSING_DATA: Cannot parse ${t} for an unknown reason`);throw a.code="MISSING_DATA",a}let o=ge(e).split(","),n=o.length,s;for(let a=0;a<n;a++)try{let u=o[a].trim(),l=Xe(r,u);s=d.decrypt(l.ciphertext,l.key);break}catch(u){if(a+1>=n)throw u}return d.parse(s)}function ke(e){console.log(`[dotenv@${K}][INFO] ${e}`)}function je(e){console.log(`[dotenv@${K}][WARN] ${e}`)}function P(e){console.log(`[dotenv@${K}][DEBUG] ${e}`)}function ge(e){return e&&e.DOTENV_KEY&&e.DOTENV_KEY.length>0?e.DOTENV_KEY:process.env.DOTENV_KEY&&process.env.DOTENV_KEY.length>0?process.env.DOTENV_KEY:""}function Xe(e,t){let r;try{r=new URL(t)}catch(u){if(u.code==="ERR_INVALID_URL"){let l=new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenvx.com/vault/.env.vault?environment=development");throw l.code="INVALID_DOTENV_KEY",l}throw u}let o=r.password;if(!o){let u=new Error("INVALID_DOTENV_KEY: Missing key part");throw u.code="INVALID_DOTENV_KEY",u}let n=r.searchParams.get("environment");if(!n){let u=new Error("INVALID_DOTENV_KEY: Missing environment part");throw u.code="INVALID_DOTENV_KEY",u}let s=`DOTENV_VAULT_${n.toUpperCase()}`,a=e.parsed[s];if(!a){let u=new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${s} in your .env.vault file.`);throw u.code="NOT_FOUND_DOTENV_ENVIRONMENT",u}return{ciphertext:a,key:o}}function de(e){let t=null;if(e&&e.path&&e.path.length>0)if(Array.isArray(e.path))for(let r of e.path)$.existsSync(r)&&(t=r.endsWith(".vault")?r:`${r}.vault`);else t=e.path.endsWith(".vault")?e.path:`${e.path}.vault`;else t=B.resolve(process.cwd(),".env.vault");return $.existsSync(t)?t:null}function le(e){return e[0]==="~"?B.join(Ve.homedir(),e.slice(1)):e}function We(e){ke("Loading env from encrypted .env.vault");let t=d._parseVault(e),r=process.env;return e&&e.processEnv!=null&&(r=e.processEnv),d.populate(r,t,e),{parsed:t}}function He(e){let t=B.resolve(process.cwd(),".env"),r="utf8",o=Boolean(e&&e.debug);e&&e.encoding?r=e.encoding:o&&P("No encoding is specified. UTF-8 is used by default");let n=[t];if(e&&e.path)if(!Array.isArray(e.path))n=[le(e.path)];else{n=[];for(let l of e.path)n.push(le(l))}let s,a={};for(let l of n)try{let g=d.parse($.readFileSync(l,{encoding:r}));d.populate(a,g,e)}catch(g){o&&P(`Failed to load ${l} ${g.message}`),s=g}let u=process.env;return e&&e.processEnv!=null&&(u=e.processEnv),d.populate(u,a,e),s?{parsed:a,error:s}:{parsed:a}}function Qe(e){if(ge(e).length===0)return d.configDotenv(e);let t=de(e);return t?d._configVault(e):(je(`You set DOTENV_KEY but you are missing a .env.vault file at ${t}. Did you forget to build it?`),d.configDotenv(e))}function Je(e,t){let r=Buffer.from(t.slice(-64),"hex"),o=Buffer.from(e,"base64"),n=o.subarray(0,12),s=o.subarray(-16);o=o.subarray(12,-16);try{let a=$e.createDecipheriv("aes-256-gcm",r,n);return a.setAuthTag(s),`${a.update(o)}${a.final()}`}catch(a){let u=a instanceof RangeError,l=a.message==="Invalid key length",g=a.message==="Unsupported state or unable to authenticate data";if(u||l){let _=new Error("INVALID_DOTENV_KEY: It must be 64 characters long (or more)");throw _.code="INVALID_DOTENV_KEY",_}else if(g){let _=new Error("DECRYPTION_FAILED: Please check your DOTENV_KEY");throw _.code="DECRYPTION_FAILED",_}else throw a}}function Ze(e,t,r={}){let o=Boolean(r&&r.debug),n=Boolean(r&&r.override);if(typeof t!="object"){let s=new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");throw s.code="OBJECT_REQUIRED",s}for(let s of Object.keys(t))Object.prototype.hasOwnProperty.call(e,s)?(n===!0&&(e[s]=t[s]),o&&P(n===!0?`"${s}" is already defined and WAS overwritten`:`"${s}" is already defined and was NOT overwritten`)):e[s]=t[s]}var d={configDotenv:He,_configVault:We,_parseVault:qe,config:Qe,decrypt:Je,parse:Ye,populate:Ze};N.exports.configDotenv=d.configDotenv;N.exports._configVault=d._configVault;N.exports._parseVault=d._parseVault;N.exports.config=d.config;N.exports.decrypt=d.decrypt;N.exports.parse=d.parse;N.exports.populate=d.populate;N.exports=d});var Ct={};xe(Ct,{handler:()=>Rt});module.exports=be(Ct);var re=D(ee());var Le={DEV:"dev",STAGING:"staging",PROD:"prod"},M=process.env.STAGE||Le.DEV,p={TOPICS:process.env.TOPICS_TABLE||`MicroQueue-Topics-${M}`,MESSAGES:process.env.MESSAGES_TABLE||`MicroQueue-Messages-${M}`,CONSUMER_GROUPS:process.env.CONSUMER_GROUPS_TABLE||`MicroQueue-ConsumerGroups-${M}`,OFFSETS:process.env.OFFSETS_TABLE||`MicroQueue-Offsets-${M}`},I={MESSAGES:process.env.MESSAGES_BUCKET||`microqueue-messages-${M}`,ARCHIVE:process.env.ARCHIVE_BUCKET||`microqueue-archive-${M}`},E={MAX_TOPIC_NAME_LENGTH:100,MAX_DESCRIPTION_LENGTH:500,MAX_MESSAGE_SIZE_BYTES:256*1024,MAX_METADATA_KEYS:10,MAX_METADATA_KEY_LENGTH:128,MAX_METADATA_VALUE_LENGTH:256,MAX_RETENTION_HOURS:7*24,DEFAULT_RETENTION_HOURS:24,MAX_MESSAGES_PER_CONSUME:100,DEFAULT_MESSAGES_PER_CONSUME:10,MAX_WAIT_TIME_SECONDS:20,DEFAULT_WAIT_TIME_SECONDS:0},f={INTERNAL_ERROR:"INTERNAL_ERROR",VALIDATION_ERROR:"VALIDATION_ERROR",RESOURCE_NOT_FOUND:"RESOURCE_NOT_FOUND",TOPIC_NOT_FOUND:"TOPIC_NOT_FOUND",TOPIC_ALREADY_EXISTS:"TOPIC_ALREADY_EXISTS",MESSAGE_NOT_FOUND:"MESSAGE_NOT_FOUND",MESSAGE_TOO_LARGE:"MESSAGE_TOO_LARGE",INVALID_MESSAGE_FORMAT:"INVALID_MESSAGE_FORMAT",CONSUMER_GROUP_NOT_FOUND:"CONSUMER_GROUP_NOT_FOUND",CONSUMER_GROUP_ALREADY_EXISTS:"CONSUMER_GROUP_ALREADY_EXISTS",RATE_LIMIT_EXCEEDED:"RATE_LIMIT_EXCEEDED",SERVICE_UNAVAILABLE:"SERVICE_UNAVAILABLE"},S={OK:200,CREATED:201,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,NOT_FOUND:404,CONFLICT:409,PAYLOAD_TOO_LARGE:413,UNPROCESSABLE_ENTITY:422,TOO_MANY_REQUESTS:429,INTERNAL_SERVER_ERROR:500,SERVICE_UNAVAILABLE:503},v={JSON:"application/json",TEXT:"text/plain",XML:"application/xml",BINARY:"application/octet-stream"};var T=class extends Error{constructor(r,o,n,s){super(o);this.code=r,this.statusCode=n,this.details=s,this.name="AppError",Error.captureStackTrace&&Error.captureStackTrace(this,T)}toResponse(){return{success:!1,error:{code:this.code,message:this.message,details:this.details}}}},c={internalError:(e="An internal server error occurred",t)=>new T(f.INTERNAL_ERROR,e,S.INTERNAL_SERVER_ERROR,t),validationError:(e="Validation error",t)=>new T(f.VALIDATION_ERROR,e,S.BAD_REQUEST,t),resourceNotFound:(e,t)=>new T(f.RESOURCE_NOT_FOUND,`${e} with id '${t}' not found`,S.NOT_FOUND),topicNotFound:e=>new T(f.TOPIC_NOT_FOUND,`Topic '${e}' not found`,S.NOT_FOUND),topicAlreadyExists:e=>new T(f.TOPIC_ALREADY_EXISTS,`Topic with name '${e}' already exists`,S.CONFLICT),messageNotFound:e=>new T(f.MESSAGE_NOT_FOUND,`Message '${e}' not found`,S.NOT_FOUND),messageTooLarge:(e,t)=>new T(f.MESSAGE_TOO_LARGE,`Message size (${e} bytes) exceeds maximum allowed size (${t} bytes)`,S.PAYLOAD_TOO_LARGE),consumerGroupNotFound:e=>new T(f.CONSUMER_GROUP_NOT_FOUND,`Consumer group '${e}' not found`,S.NOT_FOUND),consumerGroupAlreadyExists:(e,t)=>new T(f.CONSUMER_GROUP_ALREADY_EXISTS,`Consumer group with name '${e}' already exists for topic '${t}'`,S.CONFLICT),rateLimitExceeded:()=>new T(f.RATE_LIMIT_EXCEEDED,"Rate limit exceeded",S.TOO_MANY_REQUESTS),serviceUnavailable:(e="Service temporarily unavailable")=>new T(f.SERVICE_UNAVAILABLE,e,S.SERVICE_UNAVAILABLE)},te=e=>{if(console.error("Error:",e),e instanceof T)return{statusCode:e.statusCode,body:JSON.stringify(e.toResponse()),headers:{"Content-Type":"application/json"}};if(e.code==="ConditionalCheckFailedException"){let r=c.resourceNotFound("Resource","unknown");return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}if(e.code==="ThrottlingException"){let r=c.rateLimitExceeded();return{statusCode:r.statusCode,body:JSON.stringify(r.toResponse()),headers:{"Content-Type":"application/json"}}}let t=c.internalError(e.message||"An unexpected error occurred");return{statusCode:t.statusCode,body:JSON.stringify(t.toResponse()),headers:{"Content-Type":"application/json"}}};var Ge=(e,t=16)=>{let r=(0,re.nanoid)(t);return e?`${e}_${r}`:r};var oe=()=>Ge("msg");var se=(e,t)=>{let r=Date.now();return`${e}/${r}/${t}`},ne=e=>{let t=typeof e=="string"?e:JSON.stringify(e),r=Buffer.byteLength(t,"utf8");if(r>E.MAX_MESSAGE_SIZE_BYTES)throw c.messageTooLarge(r,E.MAX_MESSAGE_SIZE_BYTES)},ie=e=>{if(!e)return;let t=Object.keys(e);if(t.length>E.MAX_METADATA_KEYS)throw c.validationError(`Metadata cannot have more than ${E.MAX_METADATA_KEYS} keys`,{field:"metadata"});for(let r of t){if(r.length>E.MAX_METADATA_KEY_LENGTH)throw c.validationError(`Metadata key '${r}' exceeds maximum length of ${E.MAX_METADATA_KEY_LENGTH}`,{field:"metadata",key:r});let o=e[r];if(o&&o.length>E.MAX_METADATA_VALUE_LENGTH)throw c.validationError(`Metadata value for key '${r}' exceeds maximum length of ${E.MAX_METADATA_VALUE_LENGTH}`,{field:"metadata",key:r})}},Ue=e=>({success:!0,data:e}),ae=(e,t=200)=>({statusCode:t,body:JSON.stringify(Ue(e)),headers:{"Content-Type":"application/json"}}),ce=(e,t)=>{if(t)return t;if(typeof e=="string")try{return JSON.parse(e),v.JSON}catch{return v.TEXT}return v.JSON},ue=(e,t)=>e+t*60*60*1e3;var pe=(e,t)=>{if(!e||!e[t])throw c.validationError(`Path parameter '${t}' is required`);return e[t]},me=(e,t,r)=>{if(!e||!e[t]){if(r!==void 0)return r;throw c.validationError(`Query parameter '${t}' is required`)}return e[t]},V=(e,t,r,o)=>{let n=parseInt(e,10);if(isNaN(n))throw c.validationError(`Parameter '${t}' must be a valid integer`);if(r!==void 0&&n<r)throw c.validationError(`Parameter '${t}' must be at least ${r}`);if(o!==void 0&&n>o)throw c.validationError(`Parameter '${t}' must be at most ${o}`);return n};var Te=require("aws-sdk"),fe=D(L());fe.config();var Se={region:process.env.AWS_REGION||"us-east-1",maxRetries:3,httpOptions:{timeout:5e3},...process.env.IS_LOCAL&&{accessKeyId:"localstack",secretAccessKey:"localstack"}};process.env.DYNAMODB_ENDPOINT&&(console.log(`Using local DynamoDB endpoint: ${process.env.DYNAMODB_ENDPOINT}`),Se.endpoint=process.env.DYNAMODB_ENDPOINT);var m=new Te.DynamoDB.DocumentClient(Se);var _e=require("aws-sdk"),ye=D(L());ye.config();var R={region:process.env.AWS_REGION||"us-east-1",maxRetries:3,httpOptions:{timeout:1e4}};process.env.S3_ENDPOINT&&(console.log(`Using local S3 endpoint: ${process.env.S3_ENDPOINT}`),R.endpoint=process.env.S3_ENDPOINT,R.s3ForcePathStyle=!0,R.accessKeyId=process.env.AWS_ACCESS_KEY_ID||"minioadmin",R.secretAccessKey=process.env.AWS_SECRET_ACCESS_KEY||"minioadmin",R.signatureVersion="v4");var C=new _e.S3(R);var Ne=D(L());Ne.config();var ze={error:0,warn:1,info:2,debug:3},et=process.env.LOG_LEVEL||"info",tt=process.env.LOG_FORMAT||"json",G=ze[et]||2,U=(e,t,r)=>{let o=new Date().toISOString(),n=process.env.AWS_REQUEST_ID||"-";if(tt==="json"){let a={timestamp:o,level:e,message:t,requestId:n,service:"MicroQueue-Mini",version:"1.0.0",env:process.env.STAGE||"dev",...r?{data:r}:{}};return JSON.stringify(a)}let s=`[${o}] [${e.toUpperCase()}] [${n}] ${t}`;return r&&(s+=` ${JSON.stringify(r)}`),s},Y=class{error(t,r){G>=0&&console.error(U("error",t,r))}warn(t,r){G>=1&&console.warn(U("warn",t,r))}info(t,r){G>=2&&console.info(U("info",t,r))}debug(t,r){G>=3&&console.debug(U("debug",t,r))}},i=new Y,A=i;var rt=async(e,t)=>{i.debug("Storing message",{messageId:e.messageId,topicId:e.topicId});try{return await C.putObject({Bucket:I.MESSAGES,Key:e.payloadKey,Body:t,ContentType:e.contentType}).promise(),await m.put({TableName:p.MESSAGES,Item:e}).promise(),e}catch(r){throw i.error("Error storing message",{error:r,message:e}),r}},ot=async e=>{i.debug("Getting message by ID",{messageId:e});try{let t=await m.query({TableName:p.MESSAGES,IndexName:"MessageIdIndex",KeyConditionExpression:"messageId = :messageId",ExpressionAttributeValues:{":messageId":e},Limit:1}).promise();if(!t.Items||t.Items.length===0)throw c.messageNotFound(e);return t.Items[0]}catch(t){throw i.error("Error getting message by ID",{error:t,messageId:e}),t.code==="ResourceNotFoundException"?c.messageNotFound(e):t}},st=async(e,t,r)=>{i.debug("Getting messages",{topicId:e,fromSequence:t,limit:r});try{return(await m.query({TableName:p.MESSAGES,KeyConditionExpression:"topicId = :topicId AND sequenceNumber > :seq",ExpressionAttributeValues:{":topicId":e,":seq":t},Limit:r,ScanIndexForward:!0}).promise()).Items||[]}catch(o){throw i.error("Error getting messages",{error:o,topicId:e,fromSequence:t}),o}},nt=async e=>{i.debug("Getting message payload",{payloadKey:e});try{return(await C.getObject({Bucket:I.MESSAGES,Key:e}).promise()).Body}catch(t){throw i.error("Error getting message payload",{error:t,payloadKey:e}),t.code==="NoSuchKey"?c.resourceNotFound("Message payload",e):t}},it=async e=>{i.debug("Deleting message",{messageId:e.messageId,topicId:e.topicId});try{await m.delete({TableName:p.MESSAGES,Key:{topicId:e.topicId,sequenceNumber:e.sequenceNumber}}).promise(),await C.copyObject({Bucket:I.ARCHIVE,Key:e.payloadKey,CopySource:`${I.MESSAGES}/${e.payloadKey}`}).promise(),await C.deleteObject({Bucket:I.MESSAGES,Key:e.payloadKey}).promise()}catch(t){throw i.error("Error deleting message",{error:t,message:e}),t}},at=async e=>{i.debug("Getting next sequence number",{topicId:e});try{let t=await m.query({TableName:p.MESSAGES,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e},Limit:1,ScanIndexForward:!1}).promise();return!t.Items||t.Items.length===0?1:t.Items[0].sequenceNumber+1}catch(t){throw i.error("Error getting next sequence number",{error:t,topicId:e}),t}},ct=async e=>{i.debug("Finding expired messages",{batchSize:e});try{let t=Math.floor(Date.now()/1e3);return(await m.scan({TableName:p.MESSAGES,FilterExpression:"expiresAt < :now",ExpressionAttributeValues:{":now":t},Limit:e}).promise()).Items||[]}catch(t){throw i.error("Error finding expired messages",{error:t}),t}},y={storeMessage:rt,getMessageById:ot,getMessages:st,getMessagePayload:nt,deleteMessage:it,getNextSequenceNumber:at,findExpiredMessages:ct};var ut=async e=>{i.debug("Creating topic",{topicId:e.topicId});try{return await m.put({TableName:p.TOPICS,Item:e,ConditionExpression:"attribute_not_exists(topicId)"}).promise(),e}catch(t){throw i.error("Error creating topic",{error:t,topic:e}),t.code==="ConditionalCheckFailedException"?c.topicAlreadyExists(e.name):t}},q=async e=>{i.debug("Getting topic",{topicId:e});try{let t=await m.get({TableName:p.TOPICS,Key:{topicId:e}}).promise();if(!t.Item)throw c.topicNotFound(e);return t.Item}catch(t){throw i.error("Error getting topic",{error:t,topicId:e}),t.code==="ResourceNotFoundException"?c.topicNotFound(e):t}},pt=async e=>{i.debug("Getting topic by name",{name:e});try{let t=await m.scan({TableName:p.TOPICS,FilterExpression:"#name = :name",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e},Limit:1}).promise();return t.Items&&t.Items.length>0?t.Items[0]:null}catch(t){throw i.error("Error getting topic by name",{error:t,name:e}),t}},mt=async()=>{i.debug("Listing topics");try{return(await m.scan({TableName:p.TOPICS}).promise()).Items||[]}catch(e){throw i.error("Error listing topics",{error:e}),e}},Et=async e=>{i.debug("Deleting topic",{topicId:e});try{await m.delete({TableName:p.TOPICS,Key:{topicId:e},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(t){throw i.error("Error deleting topic",{error:t,topicId:e}),t.code==="ConditionalCheckFailedException"?c.topicNotFound(e):t}},lt=async(e,t)=>{i.debug("Incrementing topic message count",{topicId:e,timestamp:t});try{await m.update({TableName:p.TOPICS,Key:{topicId:e},UpdateExpression:"SET messageCount = messageCount + :inc, lastMessageTimestamp = :ts",ExpressionAttributeValues:{":inc":1,":ts":t},ConditionExpression:"attribute_exists(topicId)"}).promise()}catch(r){throw i.error("Error incrementing message count",{error:r,topicId:e}),r.code==="ConditionalCheckFailedException"?c.topicNotFound(e):r}},gt=async(e,t)=>{i.debug("Updating topic",{topicId:e,updates:t});let r=[],o={},n={};if(Object.entries(t).forEach(([s,a])=>{a!==void 0&&(r.push(`#${s} = :${s}`),o[`#${s}`]=s,n[`:${s}`]=a)}),r.length===0)return q(e);try{return await m.update({TableName:p.TOPICS,Key:{topicId:e},UpdateExpression:`SET ${r.join(", ")}`,ExpressionAttributeNames:o,ExpressionAttributeValues:n,ConditionExpression:"attribute_exists(topicId)",ReturnValues:"NONE"}).promise(),q(e)}catch(s){throw i.error("Error updating topic",{error:s,topicId:e}),s.code==="ConditionalCheckFailedException"?c.topicNotFound(e):s}},F={createTopic:ut,getTopic:q,getTopicByName:pt,listTopics:mt,deleteTopic:Et,incrementMessageCount:lt,updateTopic:gt};var dt=async e=>{i.debug("Creating consumer group",{groupId:e.groupId,topicId:e.topicId});try{return await m.put({TableName:p.CONSUMER_GROUPS,Item:e,ConditionExpression:"attribute_not_exists(groupId) AND attribute_not_exists(topicId)"}).promise(),e}catch(t){throw i.error("Error creating consumer group",{error:t,consumerGroup:e}),t.code==="ConditionalCheckFailedException"?c.consumerGroupAlreadyExists(e.name,e.topicId):t}},Tt=async(e,t)=>{i.debug("Getting consumer group",{groupId:e,topicId:t});try{let r=await m.get({TableName:p.CONSUMER_GROUPS,Key:{groupId:e,topicId:t}}).promise();if(!r.Item)throw c.consumerGroupNotFound(e);return r.Item}catch(r){throw i.error("Error getting consumer group",{error:r,groupId:e,topicId:t}),r.code==="ResourceNotFoundException"?c.consumerGroupNotFound(e):r}},ft=async(e,t)=>{i.debug("Getting consumer group by name",{name:e,topicId:t});try{let r=await m.scan({TableName:p.CONSUMER_GROUPS,FilterExpression:"#name = :name AND topicId = :topicId",ExpressionAttributeNames:{"#name":"name"},ExpressionAttributeValues:{":name":e,":topicId":t},Limit:1}).promise();return r.Items&&r.Items.length>0?r.Items[0]:null}catch(r){throw i.error("Error getting consumer group by name",{error:r,name:e,topicId:t}),r}},St=async e=>{i.debug("Listing consumer groups",{topicId:e});try{return(await m.query({TableName:p.CONSUMER_GROUPS,KeyConditionExpression:"topicId = :topicId",ExpressionAttributeValues:{":topicId":e}}).promise()).Items||[]}catch(t){throw i.error("Error listing consumer groups",{error:t,topicId:e}),t}},_t=async(e,t)=>{i.debug("Deleting consumer group",{groupId:e,topicId:t});try{await m.delete({TableName:p.CONSUMER_GROUPS,Key:{groupId:e,topicId:t},ConditionExpression:"attribute_exists(groupId) AND attribute_exists(topicId)"}).promise(),await m.delete({TableName:p.OFFSETS,Key:{groupId:e,topicId:t}}).promise()}catch(r){throw i.error("Error deleting consumer group",{error:r,groupId:e,topicId:t}),r.code==="ConditionalCheckFailedException"?c.consumerGroupNotFound(e):r}},yt=async(e,t,r)=>{i.debug("Updating consumer group timestamp",{groupId:e,topicId:t,timestamp:r});try{await m.update({TableName:p.CONSUMER_GROUPS,Key:{groupId:e,topicId:t},UpdateExpression:"SET lastConsumedTimestamp = :ts",ExpressionAttributeValues:{":ts":r},ConditionExpression:"attribute_exists(groupId) AND attribute_exists(topicId)"}).promise()}catch(o){throw i.error("Error updating consumer group timestamp",{error:o,groupId:e,topicId:t}),o.code==="ConditionalCheckFailedException"?c.consumerGroupNotFound(e):o}},Nt=async(e,t)=>{i.debug("Getting consumer offset",{groupId:e,topicId:t});try{let r=await m.get({TableName:p.OFFSETS,Key:{groupId:e,topicId:t}}).promise();return r.Item?r.Item:null}catch(r){throw i.error("Error getting consumer offset",{error:r,groupId:e,topicId:t}),r}},At=async e=>{i.debug("Updating consumer offset",{groupId:e.groupId,topicId:e.topicId,sequenceNumber:e.lastSequenceNumber});try{await m.put({TableName:p.OFFSETS,Item:e}).promise()}catch(t){throw i.error("Error updating consumer offset",{error:t,offset:e}),t}},x={createConsumerGroup:dt,getConsumerGroup:Tt,getConsumerGroupByName:ft,listConsumerGroups:St,deleteConsumerGroup:_t,updateConsumerGroupTimestamp:yt,getConsumerOffset:Nt,updateConsumerOffset:At};var Ot=async(e,t)=>{if(A.debug("Publishing message",{topicId:e}),!t.payload)throw c.validationError("Message payload is required");ne(t.payload),ie(t.metadata);let r=await F.getTopic(e),o=await y.getNextSequenceNumber(e),n=ce(t.payload,t.contentType),s=oe(),a=se(e,s),u=typeof t.payload=="string"?t.payload:JSON.stringify(t.payload),l=Buffer.byteLength(u,"utf8"),g=Date.now(),_=Math.floor(ue(g,r.retentionPeriodHours)/1e3),Oe={messageId:s,topicId:e,timestamp:g,sequenceNumber:o,payloadKey:a,contentType:n,size:l,metadata:t.metadata,expiresAt:_};return await y.storeMessage(Oe,u),await F.incrementMessageCount(e,g),{messageId:s,topicId:e,timestamp:g,sequenceNumber:o}},ht=async(e,t)=>{if(A.debug("Consuming messages",{topicId:e,request:t}),!t.consumerGroupId)throw c.validationError("Consumer group ID is required");let r=t.maxMessages||E.DEFAULT_MESSAGES_PER_CONSUME;if(r<1)throw c.validationError("Max messages must be at least 1");if(r>E.MAX_MESSAGES_PER_CONSUME)throw c.validationError(`Max messages cannot exceed ${E.MAX_MESSAGES_PER_CONSUME}`);let o=t.waitTimeSeconds||E.DEFAULT_WAIT_TIME_SECONDS;if(o<0)throw c.validationError("Wait time cannot be negative");if(o>E.MAX_WAIT_TIME_SECONDS)throw c.validationError(`Wait time cannot exceed ${E.MAX_WAIT_TIME_SECONDS} seconds`);await F.getTopic(e),await x.getConsumerGroup(t.consumerGroupId,e);let n=0,s=await x.getConsumerOffset(t.consumerGroupId,e);s&&(n=s.lastSequenceNumber);let a=await y.getMessages(e,n,r);if(a.length===0&&o>0){let g=Date.now()+o*1e3;for(;a.length===0&&Date.now()<g;)await new Promise(_=>setTimeout(_,500)),a=await y.getMessages(e,n,r)}if(a.length===0)return{messages:[],nextSequenceNumber:n};let u=await Promise.all(a.map(async g=>{let _=await y.getMessagePayload(g.payloadKey);return{messageId:g.messageId,payload:_.toString("utf8"),timestamp:g.timestamp,sequenceNumber:g.sequenceNumber,contentType:g.contentType,metadata:g.metadata}})),l=a[a.length-1];return await x.updateConsumerOffset({groupId:t.consumerGroupId,topicId:e,lastSequenceNumber:l.sequenceNumber,lastConsumedTimestamp:Date.now()}),await x.updateConsumerGroupTimestamp(t.consumerGroupId,e,Date.now()),{messages:u,nextSequenceNumber:l.sequenceNumber+1}},Mt=async e=>{A.debug("Getting message by ID",{messageId:e});let t=await y.getMessageById(e),r=await y.getMessagePayload(t.payloadKey);return{message:t,payload:r.toString("utf8")}},It=async e=>{A.debug("Cleaning up expired messages",{batchSize:e});let t=await y.findExpiredMessages(e);if(t.length===0)return 0;let r=0;for(let o of t)try{await y.deleteMessage(o),r++}catch(n){A.error("Error deleting expired message",{error:n,messageId:o.messageId})}return r},Ae={publishMessage:Ot,consumeMessages:ht,getMessageById:Mt,cleanupExpiredMessages:It};var Rt=async e=>{try{A.debug("Consume messages request",{event:e});let t=pe(e.pathParameters,"topicId"),r=e.queryStringParameters,o=me(r,"consumerGroupId"),n=E.DEFAULT_MESSAGES_PER_CONSUME,s=E.DEFAULT_WAIT_TIME_SECONDS;e.queryStringParameters&&(e.queryStringParameters.maxMessages&&(n=V(e.queryStringParameters.maxMessages,"maxMessages",1,E.MAX_MESSAGES_PER_CONSUME)),e.queryStringParameters.waitTimeSeconds&&(s=V(e.queryStringParameters.waitTimeSeconds,"waitTimeSeconds",0,E.MAX_WAIT_TIME_SECONDS)));let a={consumerGroupId:o,maxMessages:n,waitTimeSeconds:s},u=await Ae.consumeMessages(t,a);return ae(u)}catch(t){return A.error("Error consuming messages",{error:t}),te(t)}};0&&(module.exports={handler});
//# sourceMappingURL=consume.js.map
